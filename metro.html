<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>åœ°é“æ¢ä¹˜ç³»ç»Ÿ</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #e0e0e0;
    }
    #map { width: 100%; height: 100%; }
    svg { width: 100%; height: 100%; max-width: 1200px; max-height: 1000px; cursor: grab; }

    @keyframes glow {
      0% { stroke: #FFD700; stroke-width: 10px; opacity:1; }
      50% { stroke: #FFA500; stroke-width: 12px; opacity:0.5; }
      100% { stroke: #FFD700; stroke-width: 10px; opacity:1; }
    }
    .route-edge {
      stroke: #FFD700 !important;
      stroke-width: 10px !important;
      animation: glow 1.5s infinite;
      filter: drop-shadow(0 0 6px #FFD700);
    }
    .route-station {
      fill: #fff !important;
      stroke: #FFD700 !important;
      stroke-width: 4px !important;
      r: 14 !important;
      animation: glow 1.5s infinite;
    }
    .selected {
      stroke: #00bfff;
      stroke-width: 4px !important;
    }

    /* å·¦ä¾§åœ°å›¾å®¹å™¨ */
    #left {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background: #0f2027;
      padding: 12px; /* æ–°å¢ paddingï¼Œä¿è¯ SVG ä¸è´´è¾¹ */
    }

    #map {
      width: 100%;
      height: 100%;
      max-width: 1200px;
      max-height: 1000px;
      box-sizing: border-box;
    }

    svg {
      width: 100%;
      height: 100%;
      display: block; /* é˜²æ­¢åº•éƒ¨å‡ºç°ç©ºç™½ */
      max-width: 100%;
      max-height: 100%;
      padding: 5vh; /* å†…éƒ¨é—´è·ï¼Œé˜²æ­¢è´´è¾¹ */
    }

    /* å³ä¾§æ  - å›ºå®šå æ¯” + å†…éƒ¨å¯æ»šåŠ¨ */
    #right {
      flex: 0 0 30%;       /* é»˜è®¤å çˆ¶å®¹å™¨ 30% å®½åº¦ */
      max-width: 340px;    /* æ¡Œé¢ç«¯æœ€å¤§å®½åº¦ */
      min-width: 220px;    /* æ¡Œé¢ç«¯æœ€å°å®½åº¦ */
      padding: 16px;
      box-sizing: border-box;
      background: rgba(32, 58, 67, 0.95);
      backdrop-filter: blur(8px);
      border-left: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
    }

    /* å³ä¾§æ å†…å®¹åŒºåŸŸ */
    #steps {
      flex: 1;               /* å æ»¡å³ä¾§æ å‰©ä½™é«˜åº¦ */
      max-height: 100%;
      padding-right: 4px;    /* é¿å…æ»šåŠ¨æ¡è¦†ç›–å†…å®¹ */
    }

    /* æ‰‹æœºå±å¹•ä¸‹å¸ƒå±€ */
    @media screen and (max-width: 768px) {
      body {
        flex-direction: column;  /* å·¦å³æ”¹ä¸Šä¸‹æ’åˆ— */
      }
      #left, #map, svg {
        width: 100%;
        height: 60vh;           /* åœ°å›¾é«˜åº¦å å±å¹• 60% */
      }
      #right {
        flex: none;
        width: 100%;            /* å æ»¡å±å®½ */
        max-height: 40vh;
        max-width: none;
        border-left: none;
        border-top: 1px solid rgba(255,255,255,0.1);
        min-height: 40vh;       /* ä¿è¯å³ä¾§æ æœ‰ä¸€å®šé«˜åº¦ */
      }
      svg{
        padding: 5vh;
      }
    }


    h2 { margin: 0 0 12px 0; font-weight: 600; color: #00bfff; text-align: center; }
    .panel-section { margin-bottom: 16px; }
    label { display: block; margin-bottom: 4px; font-size: 14px; }
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: none;
      background: #203a43;
      color: #e0e0e0;
      font-size: 14px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    select:hover { background: #2c5364; }

    button {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: none;
      background: #00bfff;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover { background: #0099dd; box-shadow: 0 0 8px #00bfff; }
    .step-card {
      background: rgba(32, 58, 67, 0.8);
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      border-left: 4px solid #00bfff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      font-size: 13px;
    }
  </style>
</head>
<body>

<div id="left">
  <div id="map">
    <?xml version="1.0" encoding="UTF-8"?>
    <svg id="subway-svg" data-name="å›¾å±‚ 1" xmlns="http://www.w3.org/2000/svg" viewBox="-200 -100 2400 1500">
      <defs>
        <style>
          .cls-1, .cls-2, .cls-3, .cls-4, .cls-5, .cls-6, .cls-7, .cls-8, .cls-9, .cls-10, .cls-11, .cls-12, .cls-13, .cls-14, .cls-15, .cls-16, .cls-17, .cls-18, .cls-19, .cls-20, .cls-21, .cls-22, .cls-23, .cls-24, .cls-25, .cls-26, .cls-27, .cls-28, .cls-29, .cls-30, .cls-31, .cls-32 {
            stroke-miterlimit: 10;
          }

          .cls-1, .cls-3, .cls-6, .cls-8, .cls-9, .cls-10, .cls-12, .cls-13, .cls-14, .cls-15, .cls-16, .cls-17, .cls-20, .cls-23, .cls-26, .cls-31 {
            fill: none;
          }

          .cls-1, .cls-3, .cls-6, .cls-8, .cls-10, .cls-12, .cls-16, .cls-17, .cls-20, .cls-23, .cls-26, .cls-31 {
            stroke-width: 8px;
          }

          .cls-1, .cls-4 {
            stroke: #85d91e;
          }

          .cls-2, .cls-4, .cls-5, .cls-7, .cls-9, .cls-11, .cls-13, .cls-14, .cls-18, .cls-19, .cls-21, .cls-22 {
            stroke-width: 6px;
          }

          .cls-2, .cls-4, .cls-5, .cls-7, .cls-11, .cls-18, .cls-19, .cls-21, .cls-22 {
            fill: #fff;
          }

          .cls-2, .cls-20 {
            stroke: #a600ff;
          }

          .cls-3, .cls-21 {
            stroke: #00a6ff;
          }

          .cls-5, .cls-17 {
            stroke: red;
          }

          .cls-6, .cls-22 {
            stroke: #2fd6a4;
          }

          .cls-7, .cls-23 {
            stroke: #dbd51d;
          }

          .cls-8, .cls-9, .cls-10, .cls-13, .cls-14, .cls-15, .cls-18 {
            stroke: #949494;
          }

          .cls-9 {
            stroke-dasharray: 0 0 10.73 4.47;
          }

          .cls-10, .cls-15 {
            stroke-dasharray: 0 7;
          }

          .cls-11, .cls-16 {
            stroke: #ff00a1;
          }

          .cls-12, .cls-19 {
            stroke: #ff8a00;
          }

          .cls-13 {
            stroke-dasharray: 0 0 12 5;
          }

          .cls-15 {
            stroke-width: 7px;
          }

          /*new*/
          .leg-1, .leg-2, .leg-3, .leg-4, .leg-5, .leg-6, .leg-7, .leg-8, .leg-9,.latelan_leg,.mushroom_leg{
            stroke: silver;
            stroke-width: 5px;
          }

          .leg-1{
            fill: red;
          }
          .leg-2{
            fill: #ff00a1;
          }
          .leg-3{
            fill: #2fd6a4;
          }
          .leg-4{
            fill: #00a6ff;
          }
          .leg-5{
            fill: #85d91e;
          }
          .leg-6{
            fill: #a600ff;
          }
          .leg-7{
            fill: #ff8a00;
          }
          .leg-8{
            fill: #949494;
          }
          .leg-9{
            fill: #dbd51d;
          }
          .latelan_leg{
            fill: #ccc39d;
          }
          .mushroom_leg{
            fill: #3500ff;
          }
          .cls-33 {
            font-family: MiSans-Regular;
            dominant-baseline: middle;
            text-anchor: start;
            fill: white;
            font-size: 32px;
          }
          @font-face {
            font-family: "MiSans-Regular";
            src: url("MiSans-Regular.ttf");
          }
          .mushroom_line,.mushroom_station{
            stroke: #3500ff;
          }

          .mushroom_station{
            stroke-width: 6px;
            stroke-miterlimit: 10;
            fill:#fff;
          }
          .mushroom_line{
            stroke-miterlimit: 10;
            stroke-width: 8px;
          }
          .latelan_line,.latelan_station{
            stroke: #ccc39d;
          }
          .latelan_station{
            stroke-width: 6px;
            stroke-miterlimit: 10;
            fill:#fff;
          }
          .latelan_line{
            stroke-miterlimit: 10;
            stroke-width: 8px;
            fill:none;
          }
        </style>
      </defs>
      <line class="cls-13" x1="264.31" y1="565.45" x2="264.31" y2="613.94"  data-line-type="transfer" data-line-change='"S001","S007"'/>
      <path class="cls-9" d="M20.95,871.66l2.78,2.81c8.22,8.32,21.65,8.32,29.87,0l4.35-4.4" data-line-type="transfer" data-line-change='"S014","S020"'/>
      <path class="cls-13" d="M805.21,840.19l-11.98,25.53c-2.65,5.65-9.04,8.5-15.01,6.69l-27.13-8.2" data-line-type="transfer" data-line-change='"S012","S028"'/>
      <path class="cls-9" d="M1424.11,464.11l8.38,16.13c4.45,8.57,16.61,8.87,21.47,.53l9.72-16.65" data-line-type="transfer" data-line-change='"S004","S016"'/>
      <path class="cls-9" d="M363.26,64.28l-5.18,6.03c-18.37,21.39-19.64,52.59-3.08,75.4l8.26,11.38" data-line-type="transfer" data-line-change='"S015","S027"'/>
      <path class="cls-9" d="M737.81,464.11l11.01,14.32c5.58,7.25,16.35,7.71,22.52,.96l13.96-15.27" data-line-type="transfer" data-line-change='"S018","S026"'/>
      <path class="cls-9" d="M663,702.19h0c14.48,25.47,47.97,32.54,71.5,15.09l3.3-2.45" data-line-type="transfer" data-line-change='"S006","S025"'/>
      <path class="cls-9" d="M163.6,1016.49l-14.35,11.05c-8.75,6.74-8.75,19.92,0,26.66l14.35,11.05"  data-line-type="transfer" data-line-change='"S010","S023"'/>
      <path class="cls-9" d="M913.98,263.81l-5.55,3.85c-15.35,10.65-15.35,33.35,0,44l5.55,3.85"  data-line-type="transfer" data-line-change='"S005","S019"'/>
      <polyline class="cls-9" points="1463.68 464.11 1530.79 510" data-line-type="transfer" data-line-change='"S004","S035"'/>
      <polyline class="cls-9" points="1463.68 835.72 1530.79 800" data-line-type="transfer" data-line-change='"S003","S033"'/>
      <polyline class="cls-9" points="1463.68 835.72 1530.79 835.72" data-line-type="transfer" data-line-change='"S003","S031"'/>
      <polyline class="cls-9" points="1530.79 800  1530.79 835.72" data-line-type="transfer" data-line-change='"S031","S033"'/>
      <polyline class="cls-9" points="1956.26 835.72 1956.26 800" data-line-type="transfer" data-connet='"S032","S034"'/>
      <g id="_èŒå²›æ‚¬è½¨" data-name="èŒå²›æ‚¬è½¨" data-line-type="metro" data-line="èŒå²›æ‚¬è½¨" data-line-seq='"S031","S032"'>
        <line class="mushroom_line" x1="1530.79" y1="835.72" x2="1956.26" y2="835.72" data-line="èŒå²›æ‚¬è½¨" data-connet='"S031","S032"'/>
        <circle class="mushroom_station" cx="1956.26" cy="835.72" r="10.6" data-station-name="è˜‘è‡å²›ç¼†è½¦ç«™" data-station-id="S032" data-station-line="èŒå²›æ‚¬è½¨"/>
        <circle class="mushroom_station" cx="1530.79" cy="835.72" r="10.6" data-station-name="ä¼Šå§‹ç¼†è½¦ç«™" data-station-id="S031" data-station-line="èŒå²›æ‚¬è½¨"/>
      </g>
      <g id="_æ‹‰ç‰¹å…°ä¸“çº¿" data-name="æ‹‰ç‰¹å…°ä¸“çº¿" data-line-type="metro" data-line="æ‹‰ç‰¹å…°ä¸“çº¿" data-line-seq='"S033","S034","S035","S036","S033"'>
        <polyline class="latelan_line" points="1530.79 800 1956.26 800" data-line="æ‹‰ç‰¹å…°ä¸“çº¿" data-connet='"S033","S034"' data-direction="forward"/>
        <polyline class="latelan_line" points="1956.26 800 1956.26 510 " data-line="æ‹‰ç‰¹å…°ä¸“çº¿" data-connet='"S034","S036"' data-direction="forward"/>
        <polyline class="latelan_line" points="1530.79 510 1530.79 800" data-line="æ‹‰ç‰¹å…°ä¸“çº¿" data-connet='"S035","S033"' data-direction="forward"/>
        <polyline class="latelan_line" points="1956.26 510 1530.79 510" data-line="æ‹‰ç‰¹å…°ä¸“çº¿" data-connet='"S036","S035"' data-direction="forward"/>
        <circle class="latelan_station" cx="1530.79" cy="800" r="10.6" data-station-name="ä¼Šå§‹ç«™" data-station-id="S033" data-station-line="æ‹‰ç‰¹å…°ä¸“çº¿"/>
        <circle class="latelan_station" cx="1956.26" cy="800" r="10.6" data-station-name="è˜‘è‡å²›" data-station-id="S034" data-station-line="æ‹‰ç‰¹å…°ä¸“çº¿"/>
        <circle class="latelan_station" cx="1530.79" cy="510" r="10.6" data-station-name="ç»ˆæœ«åœ°" data-station-id="S035" data-station-line="æ‹‰ç‰¹å…°ä¸“çº¿"/>
        <circle class="latelan_station" cx="1956.26" cy="510" r="10.6" data-station-name="åŒ»è¯å…¬å¸" data-station-id="S036" data-station-line="æ‹‰ç‰¹å…°ä¸“çº¿"/>
      </g>
      <g id="_æµ·åº•è§‚å…‰åˆ—è½¦" data-name="æµ·åº•è§‚å…‰åˆ—è½¦" data-line-type="metro" data-line="æµ·åº•è§‚å…‰åˆ—è½¦" data-line-seq='"S001","S006"'>
        <path class="cls-20" d="M264.31,613.94v65.84c0,18.16,14.72,32.88,32.88,32.88h365.82" data-line="æµ·åº•è§‚å…‰åˆ—è½¦" data-connet='"S001","S006"'/>
        <circle class="cls-2" cx="264.31" cy="613.94" r="10.6" data-station-name="æµ·åº•å®«æ®¿" data-station-id="S001" data-station-line="æµ·åº•è§‚å…‰åˆ—è½¦"/>
      </g>
      <g id="_è¿œèˆªåŸé™…" data-name="è¿œèˆªåŸé™…" data-line-type="metro" data-line="è¿œèˆªåŸé™…" data-line-seq='"S028","S002","S003","S004","S005"'>
        <path class="cls-6" d="M1463.68,454.55c-.17-50.62,.83-102.62-1.17-153.62,0-11-7-19-14-27-6-5-14-9-22-9-171-2-342-1-512.53-1.13" data-line="è¿œèˆªåŸé™…" data-connet='"S004","S005"'/>
        <path class="cls-6" d="M1463.75,827.01c-.24-119.08-.24-237.08-.07-356.2" data-line="è¿œèˆªåŸé™…" data-connet='"S003","S004"'/>
        <path class="cls-6" d="M970.84,1117.94c152.67,.99,306.67,0,459.67-3.01,10-1,19-6,26-15,5-7,5-15,6-23,2-77,3-155,1.22-232.48" data-line="è¿œèˆªåŸé™…" data-connet='"S002","S003"' data-direction="forward"/>
        <path class="cls-6" d="M763.14,864.21c.37,72.72-2.63,145.72,1.37,218.72,1,4,2,9,4,13,5,9,14,17,24,18,54,3,108,3,162.29,3.84" data-line="è¿œèˆªåŸé™…" data-connet='"S028","S002"' data-direction="forward"/>
        <path id="_ä¼Šå§‹ç«™åˆ°å³¡è°·æ¹¾" data-name="ä¼Šå§‹ç«™åˆ°å³¡è°·æ¹¾" class="cls-6" d="M1464.65,836.16v235.24c0,25.85-20.96,46.81-46.81,46.81H806.87c-24.98,0-45.18-20.33-45.03-45.31l1.3-208.25c.37,72.72-2.63,145.72,1.37" data-line="è¿œèˆªåŸé™…" data-connet='"S003","S028"' data-direction="forward"/>
        <circle class="cls-22" cx="963.51" cy="1116.57" r="10.6" data-station-name="æ¾å±±ç«™" data-station-id="S002" data-station-line="è¿œèˆªåŸé™…"/>
        <circle class="cls-22" cx="1463.68" cy="835.72" r="10.6" data-station-name="ä¼Šå§‹ç«™" data-station-id="S003" data-station-line="è¿œèˆªåŸé™…"/>
        <circle class="cls-22" cx="1463.68" cy="464.11" r="10.6" data-station-name="ç»ˆæœ«åœ°" data-station-id="S004" data-station-line="è¿œèˆªåŸé™…"/>
        <circle class="cls-22" cx="913.98" cy="263.81" r="10.6" data-station-name="ä¸»åŸåŒ—" data-station-id="S005" data-station-line="è¿œèˆªåŸé™…"/>
      </g>
      <g id="_æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦" data-name="æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦" data-line-type="metro" data-line="æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦" data-line-seq='"S006","S007","S015","S008","S009","S006"'>
        <path class="cls-12" d="M655.55,689.59c-83.04,.34-167.04,2.34-250.04-.66-11-1-21-6-30-13-4-4-9-7-13-11-9-9-18-17-27-26-22-23-43-45-64.9-67.04"  data-line="æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦" data-connet='"S006","S007"' data-direction="backward"/>
        <path class="cls-12" d="M714.45,574.91c.06,31.03-.94,62.03-.94,93.03-1,9-7,16-15,20-9,4-18,2-26.88,1.38"  data-line="æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦" data-connet='"S006","S009"' data-direction="forward"/>
        <path class="cls-12" d="M622.09,263.83c21.43,.11,43.43,.11,64.43,2.11,9,1,17,5,22,13,2,4,3,8,3,12,4,89,5,178,3.11,267.27" data-line="æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦" data-connet='"S008","S009"' data-direction="backward"/>
        <path class="cls-12" d="M371.28,170.14c22.23-.2,45.23-4.2,67.23,3.8,12,5,19,16,20,28s-3,24,0,37c2,10,8,17,17,21,4,2,7,2,11,3,41,3,81,0,120.5,.94" data-line="æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦" data-connet='"S015","S008"' data-direction="backward"/>
        <path class="cls-12" d="M264.31,557.49c.21-117.56-.79-234.56,1.21-352.56,0-8,3-15,8-22,4-5,9-8,14-9,23-6,45-5,67.87-4.17" data-line="æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦" data-connet='"S007","S015"' data-direction="backward"/>
        <rect class="cls-18" x="652.79" y="678.96" width="20.43" height="46.47" rx="10.21" ry="10.21" data-station-name="è§‚æ™¯å¹³å°è½¦ç«™" data-station-id="S006" data-station-line='"æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦","æµ·åº•è§‚å…‰åˆ—è½¦"'/>
        <circle class="cls-19" cx="264.31" cy="565.45" r="10.6" data-station-name="æµ·åº•å®«æ®¿" data-station-id="S007" data-station-line="æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦"/>
        <circle class="cls-19" cx="613.98" cy="263.81" r="10.6" data-station-name="é›·ç”µä¹‹åŸ" data-station-id="S008" data-station-line="æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦"/>
        <circle class="cls-19" cx="713.3" cy="565.45" r="10.6" data-station-name="ä¸»åŸ" data-station-id="S009" data-station-line="æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦"/>
      </g>
      <g id="_è·¨æ´‹åŸé™…" data-name="è·¨æ´‹åŸé™…" data-line-type="metro" data-line="è·¨æ´‹åŸé™…" data-line-seq='"S010","S011","S012","S016","S013"'>
        <path class="cls-1" d="M1424.11,456.43c.4-11.49-.6-22.49,.4-33.49,1-13,6-26,15-36,3-2,5-6,8-8,5-3,10-7,15-10,2-1,5-2,7-3,5-2,11-3,17-4,84-2,169,2,253-1,12-3,23-14,23-26,2-107,1-214,.91-321.34" data-line="è·¨æ´‹åŸé™…" data-connet='"S013","S016"'/>
        <path class="cls-1" d="M813.23,839.69c195.29-.75,389.29,2.25,584.29-.75,12-6,23-15,25-28,2-16,1-32,2-48,1-24,0-47,0-71,1-73,0-147-.4-219.58" data-line="è·¨æ´‹åŸé™…" data-connet='"S012","S016"'/>
        <path class="cls-1" d="M163.47,907.08c1.04-16.14,1.04-33.14,4.04-49.14,6-8,14-15,24-16,202-4,404-2,605.64-2.25" data-line="è·¨æ´‹åŸé™…" data-connet='"S011","S012"'/>
        <path class="cls-1" d="M163.6,1016.49c-.09-30.55-.09-61.55-.43-92.28" data-line="è·¨æ´‹åŸé™…" data-connet='"S010","S011"'/>
        <circle class="cls-4" cx="163.6" cy="1016.49" r="10.6" data-station-name="ä¸‹åŒ—æ³½" data-station-id="S010" data-station-line="è·¨æ´‹åŸé™…"/>
        <circle class="cls-4" cx="163.6" cy="915.38" r="10.6" data-station-name="é—å¿˜æ¸©æ³‰" data-station-id="S011" data-station-line="è·¨æ´‹åŸé™…"/>
        <circle class="cls-4" cx="805.21" cy="840.19" r="10.6" data-station-name="å³¡è°·æ¹¾" data-station-id="S012" data-station-line="è·¨æ´‹åŸé™…"/>
        <circle class="cls-4" cx="1763.94" cy="13.6" r="10.6" data-station-name="å…¨æ€ªå¡”" data-station-id="S013" data-station-line="è·¨æ´‹åŸé™…"/>
      </g>
      <g id="_ç°çº¿" data-name="ç°çº¿" data-line-type="metro" data-line="ç°çº¿"  data-line-seq='"S014","S015","S016"'>
        <path class="cls-8" d="M370.86,145.85c317.65,.09,635.65-.91,953.65,1.09,17,0,30,15,30,32,0,95,0,190-.11,285.17" data-line="ç°çº¿" data-connet='"S015","S016"'/>
        <path class="cls-8" d="M63.74,864.21c.77-231.28-3.23-463.28,1.77-694.28,0-11,10-20,21-23,90-3,179,0,269.12-1.09" data-line="ç°çº¿" data-connet='"S014","S015"'/>
        <circle class="cls-18" cx="63.74" cy="864.21" r="10.6" data-station-name="é—å¿˜èŠ±å›­" data-station-id="S014" data-station-line="ç°çº¿"/>
        <rect class="cls-18" x="353.04" y="133.85" width="20.43" height="46.47" rx="10.21" ry="10.21" data-station-name="ä¸»åŸç«è½¦ç«™" data-station-id="S015" data-station-line='"ç°çº¿","æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦"'/>
        <rect class="cls-18" x="1378.57" y="417.47" width="19.75" height="93.28" rx="9.88" ry="9.88" transform="translate(1852.55 -924.34) rotate(90)" data-station-name="æœ«åœ°ä¼ é€å¤§å…ç«™(ç»ˆæœ«åœ°)" data-station-id="S016" data-station-line='"ç°çº¿","è·¨æ´‹åŸé™…"'/>
      </g>
      <g id="_ä¸»åŸåŸéƒŠçº¿" data-name="ä¸»åŸåŸéƒŠçº¿" data-line-type="metro" data-line="ä¸»åŸåŸéƒŠçº¿"  data-line-seq='"S017","S018","S019","S017"'>
        <path class="cls-17" d="M969.94,565.45c24.57-.51,49.57,4.49,73.57-3.51,7-3,13-9,16-16,1-4,3-7,3-11,4-63,4-126,0-189-1-16-16-26-30-30-37,0-73,0-110.44-.38" data-line="ä¸»åŸåŸéƒŠçº¿" data-connet='"S017","S019"'/>
        <path class="cls-17" d="M784.78,472.28c1.74,19.65-1.26,38.65,.74,58.65,0,11,5,22,15,28,8,4,16,6,25,7,43,1,85,0,128.3-.49" data-line="ä¸»åŸåŸéƒŠçº¿" data-connet='"S017","S018"'/>
        <path class="cls-17" d="M905.41,315.61c-29.9,.32-58.9-.68-88.9,1.32-12,0-22,8-28,19-1,2-2,5-2,7-3,37-2,75-2.03,112.02" data-line="ä¸»åŸåŸéƒŠçº¿" data-connet='"S018","S019"'/>
        <circle class="cls-5" cx="962.23" cy="565.45" r="10.6" data-station-name="ä¸»åŸåŸéƒŠç«™" data-station-id="S017" data-station-line="ä¸»åŸåŸéƒŠçº¿"/>
        <circle class="cls-5" cx="785.3" cy="464.11" r="10.6" data-station-name="æ‘æ°‘äº¤æ˜“æ‰€" data-station-id="S018" data-station-line="ä¸»åŸåŸéƒŠçº¿"/>
        <circle class="cls-5" cx="913.98" cy="315.51" r="10.6" data-station-name="ç†”ç‚‰å¥‡è§‚ç«™" data-station-id="S019" data-station-line="ä¸»åŸåŸéƒŠçº¿"/>
      </g>
      <g id="_é»„çº¿" data-name="é»„çº¿" data-line-type="metro" data-line="é»„çº¿"  data-line-seq='"S020","S021","S022"'>
        <path class="cls-23" d="M468.39,413.32c238.12-.39,476.12-.39,714.12-.39,18-3,31-19,32-37,1-46-3-92,2-139,1-13,14-23,28-23,89-1,179,0,268.17,.26" data-line="é»„çº¿" data-connet='"S021","S022"'/>
        <path class="cls-23" d="M13.6,864.21c.91-141.28-2.09-282.28,.91-423.28,4-13,15-26,29-26,139-5,277-1,414.58-1.61" data-line="é»„çº¿" data-connet='"S020","S021"'/>
        <circle class="cls-7" cx="13.6" cy="864.21" r="10.6" data-station-name="é—å¿˜èŠ±å›­" data-station-id="S020" data-station-line="é»„çº¿"/>
        <circle class="cls-7" cx="463.27" cy="413.32" r="10.6" data-station-name="æ¨±å¢¨ç«™" data-station-id="S021" data-station-line="é»„çº¿"/>
        <circle class="cls-7" cx="1512.69" cy="214.19" r="10.6" data-station-name="è¡€æ»´åŸå‰" data-station-id="S022" data-station-line="é»„çº¿"/>
      </g>
      <g id="_ä¸»åŸåŸé™…" data-name="ä¸»åŸåŸé™…" data-line-type="metro" data-line="ä¸»åŸåŸé™…"  data-line-seq='"S023","S024","S028","S025","S026","S027"'>
        <path id="_ä¸»åŸè¥¿è‡³ä¸‹åŒ—æ³½" data-name="ä¸»åŸè¥¿è‡³ä¸‹åŒ—æ³½" class="cls-3" d="M737.84,464.79l-.32,562.23c-.01,21.49-17.45,38.88-38.94,38.84l-534.96-1.03" data-line="ä¸»åŸåŸé™…" data-connet='"S026","S023"' data-direction="forward"/>
        <path class="cls-3" d="M737.84,458.17c-.33-120.23-.33-240.23-.33-360.23,0-17-14-33-31-33-114-3-229-1-343.26-.66" data-line="ä¸»åŸåŸé™…" data-connet='"S026","S027"'/>
        <path class="cls-3" d="M737.67,709.14c-.16-80.21-.16-159.21,.15-239.09" data-line="ä¸»åŸåŸé™…" data-connet='"S025","S026"' data-direction="backward"/>
        <path class="cls-3" d="M737.55,858.68c-.03-45.75-.03-777.75,.11-138.35" data-line="ä¸»åŸåŸé™…" data-connet='"S026","S028"' data-direction="backward"/>
        <path class="cls-3" d="M569.68,1064.15c41.83-.21,82.83,.79,124.83-.21,6,0,12-1,18-2,9-3,18-9,22-18,1-3,2-5,2-8,0-55,1-111,.96-166.14" data-line="ä¸»åŸåŸé™…" data-connet='"S024","S028"'/>
        <path class="cls-3" d="M163.6,1064.15c131.91-.21,263.91-.21,396.05,0" data-line="ä¸»åŸåŸé™…" data-connet='"S023","S024"' data-direction="forward"/>
        <circle class="cls-21" cx="163.6" cy="1064.15" r="10.6" data-station-name="ä¸‹åŒ—æ³½" data-station-id="S023" data-station-line="ä¸»åŸåŸé™…"/>
        <circle class="cls-21" cx="564.7" cy="1064.15" r="10.6" data-station-name="å…°å…°çª" data-station-id="S024" data-station-line="ä¸»åŸåŸé™…"/>
        <circle class="cls-21" cx="737.81" cy="714.83" r="10.6" data-station-name="è§‚æ™¯å¹³å°" data-station-id="S025" data-station-line="ä¸»åŸåŸé™…"/>
        <circle class="cls-21" cx="737.81" cy="464.11" r="10.6" data-station-name="ä¸»åŸè¥¿" data-station-id="S026" data-station-line="ä¸»åŸåŸé™…"/>
        <circle class="cls-21" cx="363.26" cy="64.28" r="10.6" data-station-name="ä¸°ç”°ç«™" data-station-id="S027" data-station-line="ä¸»åŸåŸé™…"/>
        <rect class="cls-18" x="740.87" y="840.98" width="20.43" height="46.47" rx="10.21" ry="10.21" transform="translate(1615.3 113.13) rotate(90)" data-station-name="å³¡è°·æ¹¾" data-station-id="S028" data-station-line='"ä¸»åŸåŸé™…","è¿œèˆªåŸé™…"'/>
      </g>
      <g id="_ç‹ç‹ç‰¹å¿«" data-name="ç‹ç‹ç‰¹å¿«" data-line-type="metro" data-line="ç‹ç‹ç‰¹å¿«"  data-line-seq='"S029","S030"'>
        <polyline class="cls-16" points="564.57 1163.3 564.57 1355.3 363.26 1355.3" data-line="ç‹ç‹ç‰¹å¿«" data-connet='"S029","S030"'/>
        <circle class="cls-11" cx="564.57" cy="1163.3" r="10.6" data-station-name="å…°å…°çªå—" data-station-id="S029" data-station-line="ç‹ç‹ç‰¹å¿«"/>
        <circle class="cls-11" cx="363.26" cy="1355.3" r="10.6" data-station-name="ç‹ä¹‹æ£®" data-station-id="S030" data-station-line="ç‹ç‹ç‰¹å¿«"/>
      </g>
      <g id="_å›¾ä¾‹" data-name="å›¾ä¾‹">
        <rect class="leg-1" x="1103.63" y="1263.62" width="128.68" height="20.68"/>
        <rect class="leg-2" x="1103.63" y="1314.42" width="128.68" height="20.68"/>
        <rect class="leg-3" x="1103.63" y="1365.21" width="128.68" height="20.68"/>
        <rect class="leg-4" x="1103.63" y="1416.01" width="128.68" height="20.68"/>
        <rect class="leg-5" x="1458.16" y="1263.62" width="128.68" height="20.68"/>
        <rect class="leg-8" x="1458.16" y="1314.42" width="128.68" height="20.68"/>
        <rect class="leg-6" x="1458.16" y="1365.21" width="128.68" height="20.68"/>
        <rect class="leg-7" x="1458.16" y="1416.01" width="128.68" height="20.68"/>
        <rect class="mushroom_leg" x="1812.69" y="1314.42" width="128.68" height="20.68"/>
        <rect class="leg-9" x="1812.69" y="1263.62" width="128.68" height="20.68"/>
        <rect class="latelan_leg" x="1812.69" y="1365.21" width="128.68" height="20.68"/>
        <text class="cls-33" transform="translate(1263.03 1275.13)"><tspan x="0" y="0">ä¸»åŸåŸéƒŠçº¿</tspan></text>
        <text class="cls-33" transform="translate(1263.03 1325.13)"><tspan x="0" y="0">ç‹ç‹ç‰¹å¿«</tspan></text>
        <text class="cls-33" transform="translate(1263.03 1375.13)"><tspan x="0" y="0">è¿œèˆªåŸé™…</tspan></text>
        <text class="cls-33" transform="translate(1263.03 1425.13)"><tspan x="0" y="0">ä¸»åŸåŸé™…</tspan></text>
        <text class="cls-33" transform="translate(1620.03 1275.13)"><tspan x="0" y="0">è·¨æ´‹åŸé™…</tspan></text>
        <text class="cls-33" transform="translate(1620.03 1325.13)"><tspan x="0" y="0">ç°çº¿</tspan></text>
        <text class="cls-33" transform="translate(1620.03 1375.13)"><tspan x="0" y="0">æµ·åº•è§‚å…‰åˆ—è½¦</tspan></text>
        <text class="cls-33" transform="translate(1620.03 1425.13)"><tspan x="0" y="0">æ»¨æµ·ç¯çº¿è§‚å…‰åˆ—è½¦</tspan></text>
        <text class="cls-33" transform="translate(1970.26 1275.13)"><tspan x="0" y="0">é»„çº¿</tspan></text>
        <text class="cls-33" transform="translate(1970.26 1325.13)"><tspan x="0" y="0">èŒå²›æ‚¬è½¨</tspan></text>
        <text class="cls-33" transform="translate(1970.26 1375.13)"><tspan x="0" y="0">æ‹‰ç‰¹å…°ä¸“çº¿</tspan></text>
      </g>
      <g id="_å­—ä¾‹" data-name="å­—ä¾‹">
        <text class="cls-33" transform="translate(880.83 610.22)"><tspan x="0" y="0">ä¸»åŸåŸéƒŠç«™</tspan></text>
        <text class="cls-33" transform="translate(803.75 465.16)"><tspan x="0" y="0">æ‘æ°‘äº¤æ˜“æ‰€</tspan></text>
        <text class="cls-33" transform="translate(834.45 359.24)"><tspan x="0" y="0">ç†”ç‚‰å¥‡è§‚ç«™</tspan></text>
        <text class="cls-33" transform="translate(867.14 230.41)"><tspan x="0" y="0">ä¸»åŸåŒ—</tspan></text>
        <text class="cls-33" transform="translate(605.38 465.19)"><tspan x="0" y="0">ä¸»åŸè¥¿</tspan></text>
        <text class="cls-33" transform="translate(620.63 567.12)"><tspan x="0" y="0">ä¸»åŸ</tspan></text>
        <text class="cls-33" transform="translate(760.95 716.58)"><tspan x="0" y="0">è§‚æ™¯å¹³å°</tspan></text>
        <text class="cls-33" transform="translate(417.37 382.35)"><tspan x="0" y="0">æ¨±å¢¨ç«™</tspan></text>
        <text class="cls-33" transform="translate(550.72 230.41)"><tspan x="0" y="0">é›·ç”µä¹‹åŸ</tspan></text>
        <text class="cls-33" transform="translate(532.79 760.62)"><tspan x="0" y="0">è§‚æ™¯å¹³å°è½¦ç«™</tspan></text>
        <text class="cls-33" transform="translate(779.89 902.09)"><tspan x="0" y="0">å³¡è°·æ¹¾</tspan></text>
        <text class="cls-33" transform="translate(318.35 17.89)"><tspan x="0" y="0">ä¸°ç”°ç«™</tspan></text>
        <text class="cls-33" transform="translate(384.71 120.04)"><tspan x="0" y="0">ä¸»åŸç«è½¦ç«™</tspan></text>
        <text class="cls-33" transform="translate(108.9 593.03)"><tspan x="0" y="0">æµ·åº•å®«æ®¿</tspan></text>
        <text class="cls-33" transform="translate(-180 865.34)"><tspan x="0" y="0">é—å¿˜èŠ±å›­ç«™</tspan></text>
        <text class="cls-33" transform="translate(189.83 915.67)"><tspan x="0" y="0">é—å¿˜æ¸©æ³‰</tspan></text>
        <text class="cls-33" transform="translate(119.58 1120)"><tspan x="0" y="0">ä¸‹åŒ—æ³½</tspan></text>
        <text class="cls-33" transform="translate(519.49 1030.56)"><tspan x="0" y="0">å…°å…°çª</tspan></text>
        <text class="cls-33" transform="translate(502.4 1121.5)"><tspan x="0" y="0">å…°å…°çªå—</tspan></text>
        <text class="cls-33" transform="translate(318.35 1319.55)"><tspan x="0" y="0">ç‹ä¹‹æ£®</tspan></text>
        <text class="cls-33" transform="translate(918.37 1082.33)"><tspan x="0" y="0">æ¾å±±ç«™</tspan></text>
        <text class="cls-33" transform="translate(1346.02 878.49)"><tspan x="0" y="0">ä¼Šå§‹ç«™</tspan></text>
        <text class="cls-33" transform="translate(1488.14 468.19)"><tspan x="0" y="0">ç»ˆæœ«åœ°</tspan></text>
        <text class="cls-33" transform="translate(1099.86 465.16)"><tspan x="0" y="0">æœ«åœ°ä¼ é€å¤§å…ç«™</tspan></text>
        <text class="cls-33" transform="translate(1533.45 217.03)"><tspan x="0" y="0">è¡€æ»´åŸå‰</tspan></text>
        <text class="cls-33" transform="translate(1716.9 -23.96)"><tspan x="0" y="0">å…¨æ€ªå¡”</tspan></text>
        <text class="cls-33" transform="translate(1506.02 878.49)"><tspan x="0" y="0">ä¼Šå§‹ç¼†è½¦ç«™</tspan></text>
        <text class="cls-33" transform="translate(1874.74 881.34)"><tspan x="0" y="0">è˜‘è‡å²›ç¼†è½¦ç«™</tspan></text>
        <text class="cls-33" transform="translate(1976.94 788.17)"><tspan x="0" y="0">è˜‘è‡å²›</tspan></text>
        <text class="cls-33" transform="translate(1976.94 513.72)"><tspan x="0" y="0">åŒ»è¯å…¬å¸</tspan></text>
        <text class="cls-33" transform="translate(1546.02 758.49)"><tspan x="0" y="0">ä¼Šå§‹ç«™</tspan></text>
      </g>
    </svg>
  </div>
</div>

<div id="right">
  <h2>åœ°é“æ¢ä¹˜ç³»ç»Ÿ</h2>

  <div class="panel-section">
    <label for="start-select">èµ·ç‚¹</label>
    <select id="start-select"><option value="">è¯·é€‰æ‹©èµ·ç‚¹</option></select>
  </div>
  <div class="panel-section">
    <label for="end-select">ç»ˆç‚¹</label>
    <select id="end-select"><option value="">è¯·é€‰æ‹©ç»ˆç‚¹</option></select>
  </div>

  <div class="panel-section">
    <button id="clearBtn">æ¸…é™¤é€‰æ‹©</button>
<!--    <button id="autoComputeBtn">è‡ªåŠ¨è®¡ç®—ï¼ˆåˆ‡æ¢ï¼‰</button>-->
  </div>

  <div class="panel-section">
    <div id="meta">ç«™æ•°ï¼šâ€”ï¼Œæ¢ä¹˜ï¼šâ€”</div>
  </div>

  <div class="panel-section" id="steps">
    <div class="step-card">è¯·é€‰æ‹©èµ·ç‚¹ä¸ç»ˆç‚¹ï¼ˆç‚¹å‡»ç«™ç‚¹æˆ–ä¸‹æ‹‰é€‰æ‹©ï¼‰</div>
  </div>
</div>

<!-- å¼•å…¥ Panzoom -->
<script src="panzoom.min.js"></script>
<script>
  /* -------------------- SVG åœ°å›¾äº¤äº’ & Panzoom -------------------- */
  document.addEventListener('DOMContentLoaded', () => {
    const svg = document.getElementById('subway-svg');

    /* -------------------- Panzoom -------------------- */
    const panzoomInstance = Panzoom(svg, {
      maxScale: 5,
      minScale: 0.5,
      contain: 'outside',
      step: 0.3
    });
    svg.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);
    svg.parentElement.addEventListener('pointerdown', panzoomInstance.pointerDown);



    /* -------------------- å·¥å…·å‡½æ•° -------------------- */
    function parseQuotedList(str) {
      if (!str) return [];
      try { const arr = JSON.parse(str); if (Array.isArray(arr)) return arr; } catch(e){}
      try { return JSON.parse("[" + str + "]"); } catch(e){}
      return str.split(',').map(s=>s.trim()).filter(Boolean);
    }

    function getStationPos(el) {
      if (el.tagName === "circle") return {
        x: +el.getAttribute("cx"),
        y: +el.getAttribute("cy")
      };
      const bb = el.getBBox();
      return { x: bb.x + bb.width/2, y: bb.y + bb.height/2 };
    }

    function dist(a, b) {
      return Math.hypot(a.x - b.x, a.y - b.y);
    }



    /* -------------------- æ„å»ºå›¾ -------------------- */
    function buildGraph(svg){
      const graph={nodes:{},edges:[]};

      svg.querySelectorAll('[data-station-id]').forEach(el=>{
        const id = el.getAttribute("data-station-id");
        graph.nodes[id] = {
          id,
          name: el.getAttribute("data-station-name") || id,
          pos: getStationPos(el),
          el
        };
        el.style.cursor="pointer";
      });

      // è½¨é“è¾¹
      svg.querySelectorAll('[data-connet]').forEach(el=>{
        const list = parseQuotedList(el.getAttribute("data-connet"));
        if (list.length < 2) return;
        const [u, v] = list;
        if (!graph.nodes[u] || !graph.nodes[v]) return;

        graph.edges.push({
          u, v,
          el,
          type: "rail",
          line: el.getAttribute("data-line") || null,
          direction: el.getAttribute("data-direction") || "both"
        });
      });

      // æ¢ä¹˜è¾¹
      svg.querySelectorAll('[data-line-type="transfer"][data-line-change]').forEach(el=>{
        const list=parseQuotedList(el.getAttribute('data-line-change'));
        if (list.length < 2) return;
        const [u,v] = list;
        if (!graph.nodes[u] || !graph.nodes[v]) return;
        graph.edges.push({
          u, v,
          el,
          type:"transfer",
          line:null,
          direction:"both"
        });
      });

      return graph;
    }



    /* -------------------- A* å¯»è·¯ï¼Œå«è·ç¦»ä¸é€Ÿåº¦ -------------------- */
    class MinHeap {
      constructor(compare){ this.data=[]; this.compare=compare; }
      isEmpty(){ return this.data.length===0; }
      push(x){ this.data.push(x); this._up(this.data.length-1); }
      pop(){
        if(this.data.length===0) return null;
        const top=this.data[0];
        const last=this.data.pop();
        if(this.data.length>0){ this.data[0]=last; this._down(0); }
        return top;
      }
      _up(i){
        const d=this.data;
        const item=d[i];
        while(i>0){
          const p=(i-1)>>1;
          if(!this.compare(item,d[p])) break;
          d[i]=d[p]; i=p;
        }
        d[i]=item;
      }
      _down(i){
        const d=this.data,len=d.length;
        const item=d[i];
        while(true){
          const l=i*2+1,r=i*2+2;
          let smallest=i;
          if(l<len && this.compare(d[l],d[smallest])) smallest=l;
          if(r<len && this.compare(d[r],d[smallest])) smallest=r;
          if(smallest===i) break;
          d[i]=d[smallest]; i=smallest;
        }
        d[i]=item;
      }
    }

    function shortestPathAStar(graph, startId, endId){
      if(!graph.nodes[startId] || !graph.nodes[endId]) return null;

      /* å»ºç«‹é‚»æ¥è¡¨ */
      const adj = {};
      for (const e of graph.edges) {
        const distance = parseFloat(e.el.getAttribute('data-line-distance')) || 1.0;
        const speed = parseFloat(e.el.getAttribute('data-speed-time')) || 1.0;
        const weight = distance / speed;

        const dir = e.el.getAttribute('data-direction') || "both";

        // u â†’ v
        if (dir === "both" || dir === "forward") {
          if (!adj[e.u]) adj[e.u] = [];
          adj[e.u].push({ id: e.v, edge: e, weight });
        }

        // v â†’ u
        if (dir === "both" || dir === "backward") {
          if (!adj[e.v]) adj[e.v] = [];
          adj[e.v].push({ id: e.u, edge: e, weight });
        }
      }


      /* A* åˆå§‹åŒ– */
      const dist={}, prev={};
      Object.keys(graph.nodes).forEach(id=>dist[id]=Infinity);
      dist[startId] = 0;

      const open = new MinHeap((a,b)=>a.f < b.f);
      open.push({ id:startId, f:0, g:0 });

      const TRANSFER = 6;

      while(!open.isEmpty()){
        const {id:u, g:gu} = open.pop();
        if(u === endId) break;

        for(const n of (adj[u] || [])){
          let ng = gu + n.weight;

          // æ¢ä¹˜æƒ©ç½š
          if(prev[u] && prev[u].edge.line !== n.edge.line){
            ng += TRANSFER;
          }

          if(ng < dist[n.id]){
            dist[n.id] = ng;
            prev[n.id] = { from:u, edge:n.edge };
            open.push({ id:n.id, g:ng, f:ng });
          }
        }
      }

      if(!prev[endId] && startId !== endId) return null;

      /* è¿˜åŸè·¯å¾„ */
      const path=[endId], edges=[];
      for(let cur=endId; cur!==startId; ){
        const p = prev[cur];
        if(!p) break;
        edges.unshift(p.edge);
        cur = p.from;
        path.unshift(cur);
      }

      return { nodes:path, edges };
    }



    /* -------------------- å•å‘ç»•è¡Œæ£€æµ‹ -------------------- *///å¼ƒç”¨

    function detectDetours(graph, result){
      const detours = [];

      for(let i=0;i<result.edges.length;i++){
        const e = result.edges[i];
        const from = result.nodes[i];
        const to   = result.nodes[i+1];

        if(!e) continue;

        const dir = e.direction || "both";
        let violates = false;

        if(dir === "forward" && e.u !== from) violates = true;
        if(dir === "backward" && e.v !== from) violates = true;

        if(violates){
          detours.push(calcDetourInfo(result, from, to));
        }
      }

      return detours;
    }

    function calcDetourInfo(result, from, to){
      let started=false;
      let count=0;
      const pass=[];

      for(let i=0;i<result.nodes.length-1;i++){
        if(result.nodes[i] === from){ started=true; continue; }
        if(started){
          pass.push(result.nodes[i]);
          count++;
          if(result.nodes[i+1] === to) break;
        }
      }

      return { from, to, count, pass };
    }

    function renderDetourMessage(detours, graph){
      if(detours.length === 0) return "";

      let html = `<div class="step-card" style="border-left:4px solid #f39c12">
      <b>ğŸš§ å•å‘çº¿è·¯ç»•è¡Œæç¤º</b><br><br>
    `;

      detours.forEach(d=>{
        const fromName = graph.nodes[d.from].name;
        const toName   = graph.nodes[d.to].name;
        const passNames = d.pass.map(id=>graph.nodes[id].name).join(" â†’ ");

        html += `
        ç”±äºã€Œ${fromName} â†’ ${toName}ã€ä¸ºå•å‘ç¦æ­¢é€šè¡Œï¼Œåˆ—è½¦å¿…é¡»æ²¿ç¯çº¿ç»•è¡Œã€‚<br>
        ğŸ‘‰ å·²è‡ªåŠ¨ç»•è¡Œ <b>${d.count}</b> ç«™ï¼š${passNames}<br><br>
      `;
      });

      html += `</div>`;
      return html;
    }



    /* -------------------- é«˜äº® -------------------- */
    function clearHighlights(svg){
      svg.querySelectorAll('.route-edge').forEach(el=>el.classList.remove('route-edge'));
      svg.querySelectorAll('.route-station').forEach(el=>el.classList.remove('route-station'));
      svg.querySelectorAll('.selected').forEach(el=>el.classList.remove('selected'));
    }

    function highlightRoute(graph, result){
      clearHighlights(svg);
      if(!result) return;

      result.nodes.forEach(id=>{
        graph.nodes[id].el.classList.add('route-station');
      });

      result.edges.forEach(e=>{
        if(e?.el) e.el.classList.add('route-edge');
      });
    }



    /* -------------------- æ¸²æŸ“æ­¥éª¤  -------------------- */

    function renderPassedStations(result, graph) {
      if (!result || !result.nodes || result.nodes.length === 0) return "";

      const names = result.nodes.map(id => graph.nodes[id].name);
      return `
    <div class="step-card">
      <b>â¡ é€”ç» ${names.length} ä¸ªç«™ç‚¹ï¼š</b><br>
      ${names.join(" â†’ ")}
    </div>
  `;
    }


    function renderSteps(graph, result){
      const container = document.getElementById("steps");
      container.innerHTML = "";

      if(!result){
        container.innerHTML = `<div class="step-card">æ‰¾ä¸åˆ°è·¯å¾„</div>`;
        return;
      }

      const nodes = result.nodes, edges = result.edges;

      if(nodes.length === 1){
        container.innerHTML = `<div class="step-card">èµ·ç‚¹å³ç»ˆç‚¹ï¼š${graph.nodes[nodes[0]].name}</div>`;
        return;
      }

      /* ---- åŸæœ‰æ­¥éª¤ç”Ÿæˆ ---- */
      let curLine=null, segStart=nodes[0];
      for(let i=0;i<edges.length;i++){
        const e=edges[i], next=nodes[i+1];
        const isTransfer = e && e.type==="transfer";
        const thisLine = e && e.line ? e.line : (isTransfer ? "æ¢ä¹˜" : null);

        if(curLine===null){ curLine=thisLine; segStart=nodes[i]; }

        if(thisLine !== curLine || isTransfer){
          if(curLine && curLine!=="æ¢ä¹˜"){
            const card=document.createElement("div");
            card.className="step-card";
            card.textContent=`ä¹˜ã€${curLine}ã€‘ä»ã€Œ${graph.nodes[segStart].name}ã€åˆ°ã€Œ${graph.nodes[nodes[i]].name}ã€`;
            container.appendChild(card);
          }
          if(curLine==="æ¢ä¹˜"){
            const card=document.createElement("div");
            card.className="step-card";
            card.textContent=`åœ¨ã€Œ${graph.nodes[segStart].name}ã€æ¢ä¹˜è‡³ã€Œ${graph.nodes[nodes[i]].name}ã€`;
            container.appendChild(card);
          }

          curLine=thisLine;
          segStart=nodes[i];
        }

        if(i===edges.length-1){
          if(thisLine && thisLine!=="æ¢ä¹˜"){
            const card=document.createElement("div");
            card.className="step-card";
            card.textContent=`ä¹˜ã€${thisLine}ã€‘ä»ã€Œ${graph.nodes[segStart].name}ã€åˆ°ã€Œ${graph.nodes[nodes[i+1]].name}ã€`;
            container.appendChild(card);
          }
        }
      }
      /* ---- é€”ç»æ¯ä¸€ç«™ ---- */
      const passedHTML = renderPassedStations(result, graph);
      if (passedHTML) {
        const div = document.createElement("div");
        div.innerHTML = passedHTML;
        container.appendChild(div);
      }

      /* ---- å•å‘ç»•è¡Œæç¤º ---- *///åºŸå¼ƒ
      const detours = detectDetours(graph, result);
      const detourHTML = renderDetourMessage(detours, graph);

      if(detourHTML){
        const div = document.createElement("div");
        div.innerHTML = detourHTML;
        container.appendChild(div);
      }
    }



    /* -------------------- é¡µé¢äº¤äº’ -------------------- */
    const graph = buildGraph(svg);
    const startSelect=document.getElementById('start-select');
    const endSelect=document.getElementById('end-select');
    const metaEl=document.getElementById('meta');

    let startId=null, endId=null;

    Object.values(graph.nodes).forEach(n=>{
      let o1=document.createElement("option");
      o1.value=n.id; o1.textContent=n.name;
      startSelect.appendChild(o1);

      let o2=document.createElement("option");
      o2.value=n.id; o2.textContent=n.name;
      endSelect.appendChild(o2);
    });

    function updateRoute(){
      if(!startId || !endId){
        clearHighlights(svg);
        renderSteps(graph, null);
        metaEl.textContent="ç«™æ•°ï¼šâ€”ï¼Œæ¢ä¹˜ï¼šâ€”";
        return;
      }

      const res = shortestPathAStar(graph, startId, endId);

      if(res){
        highlightRoute(graph, res);
        renderSteps(graph, res);

        const transfers = res.edges.filter(e=>e && e.type==="transfer").length;
        metaEl.textContent = `ç«™æ•°ï¼š${res.nodes.length}ï¼Œæ¢ä¹˜ï¼š${transfers}`;
      } else {
        metaEl.textContent="ç«™æ•°ï¼šâ€”ï¼Œæ¢ä¹˜ï¼šâ€”";
        renderSteps(graph,null);
        clearHighlights(svg);
      }
    }

    startSelect.addEventListener('change',()=>{
      startId=startSelect.value||null;
      updateRoute();
    });
    endSelect.addEventListener('change',()=>{
      endId=endSelect.value||null;
      updateRoute();
    });

    Object.values(graph.nodes).forEach(n=>{
      n.el.addEventListener("click", () => {
        if(!startId){ startId=n.id; }
        else if(!endId){ endId=n.id; }
        else { startId=n.id; endId=null; }

        startSelect.value=startId||"";
        endSelect.value=endId||"";

        updateRoute();
      });
    });

    document.getElementById("clearBtn").addEventListener("click", ()=>{
      startId=endId=null;
      startSelect.value=endSelect.value="";
      updateRoute();
    });

  });

</script>
</body>
</html>
